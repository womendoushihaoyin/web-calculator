---
name: 核心 JavaScript 逻辑
status: open
created: 2025-10-20T13:41:04Z
updated: 2025-10-20T14:00:27Z
github: https://github.com/womendoushihaoyin/web-calculator/issues/5
depends_on: [3]
parallel: false
conflicts_with: [6, 7]
---

# Task: 核心 JavaScript 逻辑

## Description

在 index.html 的 `<script>` 标签中实现计算器的核心功能逻辑,包括状态管理、数字输入处理、四则运算计算、显示区更新等。这是计算器的"大脑",负责处理所有计算逻辑和状态管理。

## Acceptance Criteria

- [ ] 定义计算器状态对象 (currentValue, previousValue, operator, waitingForNewValue)
- [ ] 实现数字输入函数 `inputDigit(digit)`
- [ ] 实现小数点输入函数 `inputDecimal()`
- [ ] 实现运算符设置函数 `setOperator(op)`
- [ ] 实现计算函数 `performCalculation()`
- [ ] 实现清除函数 `resetCalculator()`
- [ ] 实现退格函数 `deleteLastDigit()`
- [ ] 实现显示区更新函数 `updateDisplay()`
- [ ] 添加按钮点击事件监听 (使用事件委托)
- [ ] 实现浮点数精度控制 (toFixed(6))

## Technical Details

**JavaScript 代码结构**:

```javascript
// 1. 状态管理对象
const calculator = {
  currentValue: '0',
  previousValue: null,
  operator: null,
  waitingForNewValue: false
};

// 2. 数字输入处理
function inputDigit(digit) {
  if (calculator.waitingForNewValue) {
    calculator.currentValue = String(digit);
    calculator.waitingForNewValue = false;
  } else {
    calculator.currentValue =
      calculator.currentValue === '0'
        ? String(digit)
        : calculator.currentValue + digit;
  }
  updateDisplay();
}

// 3. 小数点输入
function inputDecimal() {
  if (calculator.waitingForNewValue) {
    calculator.currentValue = '0.';
    calculator.waitingForNewValue = false;
  } else if (!calculator.currentValue.includes('.')) {
    calculator.currentValue += '.';
  }
  updateDisplay();
}

// 4. 运算符设置
function setOperator(nextOperator) {
  const inputValue = parseFloat(calculator.currentValue);

  if (calculator.previousValue === null) {
    calculator.previousValue = inputValue;
  } else if (calculator.operator) {
    const result = performCalculation();
    calculator.currentValue = String(result);
    calculator.previousValue = result;
  }

  calculator.waitingForNewValue = true;
  calculator.operator = nextOperator;
  updateDisplay();
}

// 5. 计算函数
function performCalculation() {
  const prev = parseFloat(calculator.previousValue);
  const current = parseFloat(calculator.currentValue);

  if (isNaN(prev) || isNaN(current)) return current;

  let result;
  switch (calculator.operator) {
    case '+':
      result = prev + current;
      break;
    case '-':
      result = prev - current;
      break;
    case '×':
      result = prev * current;
      break;
    case '÷':
      if (current === 0) {
        alert('除数不能为零');
        resetCalculator();
        return 0;
      }
      result = prev / current;
      break;
    default:
      return current;
  }

  return parseFloat(result.toFixed(6));
}

// 6. 等号计算
function calculate() {
  if (calculator.operator && !calculator.waitingForNewValue) {
    calculator.currentValue = String(performCalculation());
    calculator.previousValue = null;
    calculator.operator = null;
    calculator.waitingForNewValue = true;
    updateDisplay();
  }
}

// 7. 清除功能
function resetCalculator() {
  calculator.currentValue = '0';
  calculator.previousValue = null;
  calculator.operator = null;
  calculator.waitingForNewValue = false;
  updateDisplay();
}

// 8. 退格功能
function deleteLastDigit() {
  if (calculator.currentValue.length > 1) {
    calculator.currentValue = calculator.currentValue.slice(0, -1);
  } else {
    calculator.currentValue = '0';
  }
  updateDisplay();
}

// 9. 显示区更新
function updateDisplay() {
  const display = document.getElementById('display');
  display.textContent = calculator.currentValue;
}

// 10. 事件监听 (事件委托)
document.querySelector('.buttons').addEventListener('click', (event) => {
  const { target } = event;

  if (!target.matches('button')) return;

  // 数字按钮
  if (target.dataset.number !== undefined) {
    inputDigit(target.dataset.number);
    return;
  }

  // 运算符按钮
  if (target.dataset.operator !== undefined) {
    setOperator(target.dataset.operator);
    return;
  }

  // 功能按钮
  if (target.dataset.action !== undefined) {
    switch (target.dataset.action) {
      case 'clear':
        resetCalculator();
        break;
      case 'delete':
        deleteLastDigit();
        break;
      case 'decimal':
        inputDecimal();
        break;
      case 'equals':
        calculate();
        break;
    }
  }
});

// 页面加载时初始化显示
updateDisplay();
```

**关键实现要点**:
- **事件委托**: 使用单一事件监听器处理所有按钮点击,提高性能
- **精度控制**: 使用 `toFixed(6)` 限制小数位数,避免 JavaScript 浮点数问题
- **除零处理**: 检测除数为 0 时弹出警告并重置计算器
- **连续运算**: 支持 `5 + 3 + 2 =` 这样的连续计算
- **状态标志**: `waitingForNewValue` 标志用于控制运算符后的新输入

## Dependencies

- [ ] Task 3: HTML 结构开发完成 (需要按钮元素和 data 属性)

## Effort Estimate

- **Size**: L
- **Hours**: 4-5 小时
- **Parallel**: false (会被 Task 6 和 7 扩展,需顺序执行)

## Definition of Done

- [ ] JavaScript 代码已完整添加到 index.html 的 `<script>` 标签
- [ ] 所有四则运算功能正常工作
- [ ] 数字输入和小数点功能正常
- [ ] 清除和退格功能正常
- [ ] 除零错误正确处理
- [ ] 通过手工测试用例:
  - [ ] `123 + 456 = 579`
  - [ ] `12.5 × 4 = 50`
  - [ ] `100 - 20 + 30 = 110`
  - [ ] `5 - 10 = -5`
  - [ ] `10 ÷ 0` → 错误提示
- [ ] 无控制台错误
- [ ] 代码已提交到 Git
