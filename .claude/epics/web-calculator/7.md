---
name: 错误处理与边界条件
status: open
created: 2025-10-20T13:41:04Z
updated: 2025-10-20T14:00:27Z
github: https://github.com/womendoushihaoyin/web-calculator/issues/7
depends_on: [5]
parallel: true
conflicts_with: [5]
---

# Task: 错误处理与边界条件

## Description

完善计算器的错误处理和边界条件处理逻辑,确保在各种异常情况下都能稳定运行。处理除零错误、大数显示、重复输入、空输入等边界情况,提供友好的错误提示和自动恢复机制。

## Acceptance Criteria

- [ ] 除零错误检测和处理 (已在 Task 5 实现,此处增强)
- [ ] 大数显示处理 (超过显示区宽度时自动滚动或科学计数法)
- [ ] 重复小数点输入限制 (已在 Task 5 实现,此处验证)
- [ ] 空输入退格处理 (保持 '0' 显示)
- [ ] 连续运算符输入处理 (替换为最新运算符)
- [ ] 显示区溢出处理 (CSS overflow-x: auto)
- [ ] 非法输入过滤 (如多个小数点、字母等)
- [ ] 错误提示优化 (使用更友好的提示方式)

## Technical Details

**增强的错误处理代码** (修改 Task 5 中的相关函数):

```javascript
// 1. 增强的数字输入函数 (添加最大长度限制)
function inputDigit(digit) {
  const MAX_LENGTH = 15; // 最大输入长度

  if (calculator.waitingForNewValue) {
    calculator.currentValue = String(digit);
    calculator.waitingForNewValue = false;
  } else {
    if (calculator.currentValue.length >= MAX_LENGTH) {
      return; // 超过最大长度,忽略输入
    }
    calculator.currentValue =
      calculator.currentValue === '0'
        ? String(digit)
        : calculator.currentValue + digit;
  }
  updateDisplay();
}

// 2. 增强的小数点输入函数
function inputDecimal() {
  if (calculator.waitingForNewValue) {
    calculator.currentValue = '0.';
    calculator.waitingForNewValue = false;
  } else if (!calculator.currentValue.includes('.')) {
    calculator.currentValue += '.';
  } else {
    // 已有小数点,忽略重复输入 (无需提示)
    return;
  }
  updateDisplay();
}

// 3. 增强的除零处理
function performCalculation() {
  const prev = parseFloat(calculator.previousValue);
  const current = parseFloat(calculator.currentValue);

  if (isNaN(prev) || isNaN(current)) return current;

  let result;
  switch (calculator.operator) {
    case '+':
      result = prev + current;
      break;
    case '-':
      result = prev - current;
      break;
    case '×':
      result = prev * current;
      break;
    case '÷':
      if (current === 0) {
        // 优化错误提示
        showError('除数不能为零');
        resetCalculator();
        return 0;
      }
      result = prev / current;
      break;
    default:
      return current;
  }

  // 处理大数显示 (科学计数法)
  if (Math.abs(result) > 1e15 || (Math.abs(result) < 1e-6 && result !== 0)) {
    return parseFloat(result.toExponential(6));
  }

  return parseFloat(result.toFixed(6));
}

// 4. 友好的错误提示函数
function showError(message) {
  const display = document.getElementById('display');
  const originalValue = display.textContent;

  display.textContent = message;
  display.style.color = '#e53e3e'; // 红色

  setTimeout(() => {
    display.style.color = '#ffffff';
    display.textContent = originalValue;
  }, 2000);
}

// 5. 增强的退格函数 (处理空输入)
function deleteLastDigit() {
  if (calculator.waitingForNewValue) {
    return; // 等待新输入时不允许退格
  }

  if (calculator.currentValue.length > 1) {
    calculator.currentValue = calculator.currentValue.slice(0, -1);
  } else {
    calculator.currentValue = '0'; // 确保不会为空
  }
  updateDisplay();
}

// 6. 连续运算符处理 (已在 Task 5 的 setOperator 中实现,此处验证)
// setOperator 函数会自动替换运算符,无需额外处理
```

**CSS 增强** (添加到 Task 4 的样式中):
```css
/* 显示区溢出处理 */
.display {
  overflow-x: auto;
  white-space: nowrap;
  scrollbar-width: thin;
}

.display::-webkit-scrollbar {
  height: 4px;
}

.display::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.3);
  border-radius: 2px;
}
```

**边界条件测试用例**:
1. **除零**: `10 ÷ 0` → 显示 "除数不能为零" 2秒后重置
2. **大数**: `999999999 × 999999999` → 显示科学计数法
3. **重复小数点**: `1.2.3` → 只输入 `1.23` (忽略第二个小数点)
4. **空退格**: 输入 `5` 后连续退格 → 显示 `0` (不为空)
5. **最大长度**: 输入 16 位数字 → 只保留前 15 位
6. **连续运算符**: `5 + - ×` → 只保留最后的 `×`

## Dependencies

- [ ] Task 5: 核心 JavaScript 逻辑完成 (需要修改已有函数)

## Effort Estimate

- **Size**: M
- **Hours**: 2-3 小时
- **Parallel**: true (可与键盘支持并行,但建议在 Task 5 完成后进行)

## Definition of Done

- [ ] 所有边界条件处理代码已添加/修改
- [ ] 除零错误显示友好提示并自动恢复
- [ ] 大数正确显示为科学计数法
- [ ] 重复小数点被正确忽略
- [ ] 退格功能不会导致空显示
- [ ] 最大输入长度限制生效
- [ ] 通过所有边界条件测试用例
- [ ] 无控制台错误或警告
- [ ] 代码已提交到 Git
